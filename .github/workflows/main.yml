name: BOT L4 Y L7

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: üîê CREAR token.txt DESDE KEYS
        env:
          DISCORD_TOKEN: ${{ secrets.KEYS }}
        run: |
          echo "=== CREANDO token.txt ==="
          
          # Verificar que el secret existe
          if [ -z "$DISCORD_TOKEN" ]; then
            echo "‚ùå ERROR: Secret 'KEYS' no configurado"
            echo ""
            echo "SOLUCI√ìN R√ÅPIDA:"
            echo "1. Ve a Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. New repository secret"
            echo "3. Name: KEYS"
            echo "4. Value: [PEGA TU TOKEN AQU√ç]"
            echo "5. Add secret"
            exit 1
          fi
          
          # Crear token.txt con el token
          echo "$DISCORD_TOKEN" > token.txt
          
          # Verificar que se cre√≥
          if [ ! -f "token.txt" ]; then
            echo "‚ùå ERROR: No se pudo crear token.txt"
            exit 1
          fi
          
          # Mostrar informaci√≥n (sin revelar token completo)
          TOKEN_LENGTH=$(wc -c < token.txt)
          echo "‚úÖ token.txt creado exitosamente"
          echo "   Ubicaci√≥n: $(pwd)/token.txt"
          echo "   Tama√±o: $TOKEN_LENGTH caracteres"
          echo "   Permisos: $(ls -la token.txt)"
          echo "   Primeros chars: $(head -c 10 token.txt)..."
          
          # Asegurar permisos correctos
          chmod 644 token.txt

      - name: üìã VERIFICAR token.txt
        run: |
          echo "=== VERIFICANDO token.txt ==="
          
          # Verificar que existe y tiene contenido
          if [ ! -f "token.txt" ]; then
            echo "‚ùå ERROR CR√çTICO: token.txt NO existe"
            echo "El archivo deber√≠a estar en: $(pwd)/token.txt"
            ls -la $(pwd)
            exit 1
          fi
          
          if [ ! -s "token.txt" ]; then
            echo "‚ùå ERROR: token.txt est√° vac√≠o"
            exit 1
          fi
          
          TOKEN_CONTENT=$(cat token.txt)
          TOKEN_LENGTH=${#TOKEN_CONTENT}
          
          echo "‚úÖ token.txt VERIFICADO"
          echo "   Existe: ‚úì"
          echo "   No vac√≠o: ‚úì"
          echo "   Longitud: $TOKEN_LENGTH caracteres"
          
          # Validar formato b√°sico de token Discord
          if [ $TOKEN_LENGTH -lt 50 ]; then
            echo "‚ö†Ô∏è  ADVERTENCIA: Token muy corto para Discord (debe ser ~59 chars)"
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc g++ make libpcap-dev libssl-dev
          pip install discord.py
          
          # Dependencias Go opcionales
          go get github.com/sandertv/go-raknet 2>/dev/null || true

      - name: Build all binaries
        run: |
          echo "=== COMPILANDO M√âTODOS ==="
          
          # Lista de m√©todos a compilar
          declare -A methods=(
            ["udpbypass.c"]=""
            ["tcp.c"]=""
            ["tcp-syn.c"]="-lpcap"
            ["tcp-ack.c"]="-lpcap"
            ["tcp-tls.c"]="-lssl -lcrypto"
            ["dns.c"]=""
            ["ntp.c"]=""
            ["httpsraw.c"]=""
            ["tls.c"]="-lssl -lcrypto"
            ["httpsrequest.c"]=""
            ["udp.c"]=""
            ["udphex.c"]=""
            ["udppps.c"]=""
            ["ovh.c"]="-lpcap"
            ["udppayload.c"]=""
          )
          
          for source in "${!methods[@]}"; do
            if [ -f "$source" ]; then
              binary="${source%.c}"
              libs="${methods[$source]}"
              
              echo -n "üî® $source ‚Üí $binary ... "
              
              if gcc -O3 -pthread "$source" -o "$binary" $libs 2>/dev/null; then
                chmod +x "$binary"
                echo "‚úÖ"
              else
                # Intentar sin librer√≠as si falla
                if [ -n "$libs" ]; then
                  if gcc -O3 -pthread "$source" -o "$binary" 2>/dev/null; then
                    chmod +x "$binary"
                    echo "‚úÖ (sin libs)"
                  else
                    echo "‚ùå"
                  fi
                else
                  echo "‚ùå"
                fi
              fi
            fi
          done
          
          echo ""
          echo "üìÇ Ejecutables disponibles:"
          ls -la | grep -E '^-..x.*' | awk '{print $9}' || echo "No hay ejecutables"

      - name: üöÄ EJECUTAR BOT
        run: |
          echo "========================================"
          echo "ü§ñ INICIANDO BOT UDP/TCP/AMP/L7"
          echo "========================================"
          
          # VERIFICACI√ìN EXTRA ANTES DE EJECUTAR
          echo ""
          echo "üîç VERIFICACI√ìN FINAL:"
          echo "---------------------"
          
          # 1. Verificar bot.py
          if [ ! -f "bot.py" ]; then
            echo "‚ùå ERROR: bot.py no encontrado"
            ls -la
            exit 1
          fi
          echo "‚úÖ bot.py encontrado"
          
          # 2. Verificar token.txt
          if [ ! -f "token.txt" ]; then
            echo "‚ùå ERROR: token.txt no encontrado"
            echo "Buscando en: $(pwd)"
            ls -la
            exit 1
          fi
          echo "‚úÖ token.txt encontrado"
          
          # 3. Verificar que token.txt tenga contenido
          if [ ! -s "token.txt" ]; then
            echo "‚ùå ERROR: token.txt est√° vac√≠o"
            echo "Contenido: '$(cat token.txt)'"
            exit 1
          fi
          echo "‚úÖ token.txt no est√° vac√≠o"
          
          # 4. Mostrar primeros caracteres del token
          TOKEN_PREVIEW=$(head -c 15 token.txt)
          TOKEN_LENGTH=$(wc -c < token.txt)
          echo "‚úÖ Token: ${TOKEN_PREVIEW}... ($TOKEN_LENGTH caracteres)"
          
          echo ""
          echo "‚ö° INICIANDO EJECUCI√ìN..."
          echo "========================================"
          
          # Ejecutar bot.py
          python3 bot.py
          
          echo ""
          echo "========================================"
          echo "ü§ñ BOT FINALIZADO"
          echo "========================================"
